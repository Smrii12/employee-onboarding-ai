<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Employee Onboarding</title>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4bb543;
            --warning: #f8961e;
            --danger: #f94144;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: #f5f7fa;
        }
        
        .dashboard-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .menu-item.active {
            background: rgba(255,255,255,0.2);
            border-left: 3px solid var(--accent);
        }
        
        /* Main Content Styles */
        .main-content {
            padding: 30px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: rgba(67, 97, 238, 0.1);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .stat-card h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }
        
        .stat-change {
            display: flex;
            align-items: center;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .stat-change.up {
            color: var(--success);
        }
        
        .stat-change.down {
            color: var(--danger);
        }
        
        /* Onboarding Table */
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #f1f1f1;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }
        
        .employee-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active {
            background: #e3f2fd;
            color: var(--primary);
        }
        
        .status-completed {
            background: #e8f5e9;
            color: var(--success);
        }
        
        .status-pending {
            background: #fff3e0;
            color: var(--warning);
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            font-size: 14px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Section Styles */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }

        /* Task Management Styles */
        .task-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Employee Detail Modal */
        .employee-detail {
            margin-top: 20px;
        }

        .progress-section {
            margin-bottom: 20px;
        }

        .progress-item {
            margin-bottom: 15px;
        }

        .progress-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .progress-value {
            font-weight: 500;
            color: var(--primary);
        }

        .status-dropdown {
    padding: 5px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.status-dropdown option {
    font-weight: 500;
}
.status-dropdown option[value="Not Started"] {
    background-color: #f8d7da; /* light red */
    color: #721c24; /* dark red text */
}

.status-dropdown option[value="In Progress"] {
    background-color: #fff3cd; /* light yellow */
    color: #856404; /* dark yellow text */
}

.status-dropdown option[value="Completed"] {
    background-color: #d4edda; /* light green */
    color: #155724; /* dark green text */
}
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Onboarding Pro</h2>
                <p>Admin Dashboard</p>
            </div>
            
            <div class="sidebar-menu">
                <div class="menu-item active" data-section="admin-section">
                    <i class="fas fa-user-cog"></i>
                    <span>Admin</span>
                </div>
                <div class="menu-item" data-section="tasks-section">
                    <i class="fas fa-tasks"></i>
                    <span>Tasks</span>
                </div>
                <div id="training-section-btn" class="menu-item" data-section="training-section">
                    <i class="fas fa-video"></i>
                    <span>Training Videos</span>
                </div>
                <div class="menu-item" data-section="reports-section">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </div>
                <div class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Admin Section -->
            <div id="admin-section" class="section active">
                <div class="header">
                    <div>
                        <h1>Employee Onboarding</h1>
                        <p>Manage and track new hire progress</p>
                    </div>
                    
                    <div class="header-actions">
                        <!-- <button class="btn btn-outline">
                            <i class="fas fa-download"></i> Export
                        </button> -->
                        <button class="btn btn-primary" id="addEmployeeBtn">
                            <i class="fas fa-plus"></i> Add Employee
                        </button>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats will be loaded via JavaScript -->
                </div>
                
                <!-- Onboarding Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Employee Name</th>
                                <th>Start Date</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Actions</th>
                                <!-- <th><button id="predict-btn">Predict Progress</button></th> -->
                                
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <!-- Employees will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tasks Section -->
            <div id="tasks-section" class="section">
                <div class="header">
                    <div>
                        <h1>Task Management</h1>
                        <p>Assign and track employee tasks</p>
                    </div>
                </div>

                <div class="task-form">
                    <h3>Assign New Task</h3>
                    <form id="taskForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskEmpId">Employee ID</label>
                                <input type="text" id="taskEmpId" required>
                            </div>
                            <div class="form-group">
                                <label for="taskEmpName">Employee Name</label>
                                <input type="text" id="taskEmpName" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="taskName">Task Name</label>
                            <input type="text" id="taskName" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskCategory">Category</label>
                                <select id="taskCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="Paperwork">Paperwork</option>
                                    <option value="Training">Training</option>
                                    <option value="Orientation">Orientation</option>
                                    <option value="Compliance">Compliance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taskAssignedBy">Assigned By</label>
                                <input type="text" id="taskAssignedBy" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="taskDueDate">Start Date</label>
                            <input type="date" id="taskDueDate" required>
                        </div>

                        <div class="form-group">
                            <label for="taskStatus">Status</label>
                                <select id="taskStatus" required>
                                     <option value="Not Started">Not Started</option>
                                    <option value="In Progress">In Progress</option>
                                     <option value="Completed">Completed</option>
                                    </select>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-outline" onclick="resetTaskForm()">Clear</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Assign Task
                            </button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <h3 style="padding: 15px 20px; margin: 0;">Assigned Tasks</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Employee Name</th>
                                <th>Task Name</th>
                                <th>Category</th>
                                <th>Assigned By</th>
                                <th>Start Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <!-- Tasks will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
           <!-- Training Videos Section -->
<div id="training-section" class="section">
    <div class="header">
        <div>
            <h1>Training Videos</h1>
            <p>Manage training materials for employees</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" id="addVideoBtn">
                <i class="fas fa-plus"></i> Add Video
            </button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Duration</th>
                    <th>Category</th>
                    <th>Upload Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="videosTableBody">
                <!-- Videos will be loaded via JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Add Video Modal inside the training section -->
    <div class="modal" id="addVideoModal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeVideoModal()">&times;</span>
        <form id="videoForm">
          <div class="form-group">
            <label for="videoTitle">Title</label>
            <input type="text" id="videoTitle" required>
          </div>

          <div class="form-group">
            <label for="videoDuration">Duration (e.g., 10:30)</label>
            <input type="text" id="videoDuration" required>
          </div>

          <div class="form-group">
            <label for="videoCategory">Category</label>
            <input type="text" id="videoCategory" required>
          </div>

          <div class="form-group">
            <label for="videoURL">YouTube URL</label>
            <input type="url" id="videoURL" placeholder="https://www.youtube.com/embed/VIDEO_ID" required>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-outline" onclick="closeAddVideoModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Video</button>
          </div>
        </form>
      </div>
    </div>
</div>


            <!-- Reports Section -->
            <div id="reports-section" class="section">
    <div class="header">
        <div>
            <h1>Reports</h1>
            <p>View onboarding analytics and reports</p>
        </div>
    </div>

    <div style="background: white; border-radius: 10px; padding: 20px;">
        <button class="btn btn-primary" id="generateReportBtn" style="margin-bottom: 15px;">
            <i class="fas fa-download"></i> Generate Report
        </button>

        <div id="report-container" style="overflow-x:auto;">
            <!-- Report tables will be injected here dynamically -->
        </div>
        <hr>
<h3>Progress Predictor</h3>
<div id="predictor">
  <label>Time Spent (hours):</label>
  <input type="number" id="timeSpentInput" min="0" step="1">

  <label>Task Type:</label>
  <select id="taskTypeInput">
    <option value="Onboarding">Onboarding</option>
    <option value="Training">Training</option>
    <option value="Documentation">Documentation</option>
    <option value="Other">Other</option>
  </select>

  <label>Previous Delays:</label>
  <input type="number" id="previousDelaysInput" min="0" step="1">

  <button class="btn btn-primary" onclick="predictProgressReport()">Predict</button>
</div>

<div id="predictionResult" style="margin-top: 15px; font-weight: bold;"></div>

    </div>
</div>

    
    <!-- Add Employee Modal -->
    <div class="modal" id="addEmployeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Employee</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <form id="employeeForm">
                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                
                <div class="form-group">
                    <label for="position">Position</label>
                    <input type="text" id="position" required>
                </div>
                
                <div class="form-group">
                    <label for="department">Department</label>
                    <select id="department" required>
                        <option value="">Select Department</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Marketing">Marketing</option>
                        <option value="HR">Human Resources</option>
                        <option value="Sales">Sales</option>
                        <option value="Design">Design</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span id="submitText">Add Employee</span>
                        <span id="submitSpinner" class="spinner" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employee Detail Modal -->
    <div class="modal" id="employeeDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Employee Details</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div id="employeeDetailContent">
                <!-- Employee details will be loaded here -->
            </div>
        </div>
    </div>

     <div id="employee-actions-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeEmployeeActions()">&times;</span>
      <h2>Employee Actions</h2>

      <form id="employee-actions-form">
        <label>
          <input type="checkbox" id="forms_completed"> Form Submissions
        </label><br>
        <label>
          <input type="checkbox" id="videos_completed"> Training Videos
        </label><br>
        <label>
          <input type="checkbox" id="documents_uploaded"> Document Uploads
        </label><br>

        <button type="button" onclick="saveEmployeeActions()">Save</button>
      </form>
    </div>
  </div>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:5000';
        
        // DOM Elements
        const modal = document.getElementById('addEmployeeModal');
        const empDetailModal = document.getElementById('employeeDetailModal');
        const openBtn = document.getElementById('addEmployeeBtn');
        const closeBtns = document.querySelectorAll('.close-modal');
        const employeeForm = document.getElementById('employeeForm');
        const taskForm = document.getElementById('taskForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');
        const employeesTableBody = document.getElementById('employeesTableBody');
        const tasksTableBody = document.getElementById('tasksTableBody');
        const videosTableBody = document.getElementById('videosTableBody');
        const statsGrid = document.getElementById('statsGrid');
        const menuItems = document.querySelectorAll('.menu-item');
        const sections = document.querySelectorAll('.section');


        function openEmployeeActions(emp_id) {
    fetch(`/api/employees/${emp_id}`)
        .then(res => res.json())
        .then(employee => {
            // Pre-fill checkboxes based on progress
            document.getElementById("forms_completed").checked = employee.progress.forms_completed > 0;
            document.getElementById("videos_completed").checked = employee.progress.videos_completed > 0;
            document.getElementById("documents_uploaded").checked = employee.progress.documents_uploaded > 0;

            // Show modal
            document.getElementById("employee-actions-modal").style.display = "block";

            // Store current emp_id globally for saving later
            window.currentEmpId = emp_id;
        })
        .catch(err => {
            alert("Error loading employee actions");
            console.error(err);
        });
}

function closeEmployeeActions() {
    document.getElementById("employee-actions-modal").style.display = "none";
}

// Attach event listeners to checkboxes to auto-update backend
["forms_completed", "videos_completed", "documents_uploaded"].forEach(id => {
    document.getElementById(id).addEventListener("change", function() {
        const update = {
            forms_completed: document.getElementById("forms_completed").checked ? 1 : 0,
            videos_completed: document.getElementById("videos_completed").checked ? 1 : 0,
            documents_uploaded: document.getElementById("documents_uploaded").checked ? 1 : 0,
        };

        // Send update to backend
        fetch(`/api/employees/${window.currentEmpId}/progress`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(update)
        })
        .then(res => res.json())
        .then(data => console.log("Progress updated:", data))
        .catch(err => console.error("Update failed", err));
    });
});


function saveEmployeeActions() {
    const data = {
        forms_completed: document.getElementById("forms_completed").checked ? 1 : 0,
        videos_completed: document.getElementById("videos_completed").checked ? 1 : 0,
        documents_uploaded: document.getElementById("documents_uploaded").checked ? 1 : 0
    };

    fetch(`/api/employees/${window.currentEmpId}/progress`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(async updated => {
        alert("Employee progress updated!");
        closeEmployeeActions();
        await fetchEmployees();   // ✅ refresh employees list
        await fetchStats();       // ✅ refresh stats
    })
    .catch(err => {
        console.error("Error updating progress:", err);
        alert("Error updating progress");
    });
}


               // Menu navigation
        menuItems.forEach(item => {
            if (item.getAttribute('data-section')) {
                item.addEventListener('click', () => {
                    const targetSection = item.getAttribute('data-section');
                    
                    // Update active menu item
                    menuItems.forEach(mi => mi.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Show target section
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetSection).classList.add('active');
                    
                    // Load section-specific data
                    if (targetSection === 'tasks-section') {
                        fetchTasks();
                    } else if (targetSection === 'training-section') {
                        fetchTrainingVideos();
                    } else if (targetSection === 'admin-section') {
                        fetchEmployees();
                        fetchStats();
                    }
                });
            }
        });

        // Modal functionality
        openBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
        });
        
        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                modal.style.display = 'none';
                empDetailModal.style.display = 'none';
            });
        });
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
            if (e.target === empDetailModal) {
                empDetailModal.style.display = 'none';
            }
        });

        // Form submission - Employee
        employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading state
            submitText.textContent = 'Adding...';
            submitSpinner.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            const employeeData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                position: document.getElementById('position').value,
                department: document.getElementById('department').value,
                startDate: document.getElementById('startDate').value
            };

            try {
                const response = await fetch(`/api/employees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(employeeData)
                });

                if (response.ok) {
                    modal.style.display = 'none';
                    employeeForm.reset();
                    await fetchEmployees();
                    const activeSection = document.querySelector('.section.active').id;
if (activeSection === 'tasks-section') {
    await fetchTasks(); // refresh tasks table immediately
}

                    await fetchStats();
                    alert('Employee added successfully!');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to add employee');
                }
            } catch (error) {
                console.error('Error:', error);
                alert(`Error adding employee: ${error.message}`);
            } finally {
                // Reset button state
                submitText.textContent = 'Add Employee';
                submitSpinner.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Reset task form
        function resetTaskForm() {
            taskForm.reset();
        }

        // Employee table update function
        function updateEmployeeTable(employees) {
    employeesTableBody.innerHTML = '';
    
    employees.forEach(employee => {
        const progress = employee.progress;
        const totalItems = progress.total_forms + progress.total_videos + progress.total_documents;
        const completedItems = progress.forms_completed + progress.videos_completed + progress.documents_uploaded;
        const progressPercentage = Math.round((completedItems / totalItems) * 100);
        const status = progressPercentage === 100 ? 'completed' : 
                      progressPercentage > 0 ? 'active' : 'pending';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employee.emp_id}</td>
            <td>
                <div class="employee-info">
                    <div class="employee-avatar">${employee.firstName.charAt(0)}${employee.lastName.charAt(0)}</div>
                    <div>
                        <p style="font-weight: 500; margin: 0;">${employee.firstName} ${employee.lastName}</p>
                        <p style="font-size: 12px; color: #6c757d; margin: 0;">${employee.position}</p>
                    </div>
                </div>
            </td>
            <td>${new Date(employee.startDate).toLocaleDateString()}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 60px; text-align: right;">${progressPercentage}%</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                    </div>
                </div>
            </td>
            <td>
                <span class="status-badge status-${status}">
                    ${status.charAt(0).toUpperCase() + status.slice(1)}
                </span>
            </td>
            <td>
    <button class="action-btn" onclick="openEmployeeActions('${employee.emp_id}')">
        <i class="fas fa-tasks"></i> Action
    </button>
    <button class="action-btn" style="color: var(--danger);" onclick="deleteEmployee('${employee.emp_id}')">
        <i class="fas fa-trash"></i> Delete
    </button>

        `;
        employeesTableBody.appendChild(row);
    });

}

async function predictProgressReport() {
  const timeSpent = document.getElementById("timeSpentInput").value;
  const taskType = document.getElementById("taskTypeInput").value;
  const previousDelays = document.getElementById("previousDelaysInput").value;

  if (!timeSpent || !taskType || previousDelays === "") {
    alert("All inputs are required!");
    return;
  }

  try {
    const response = await fetch('/api/predict-progress', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        time_spent_hours: parseFloat(timeSpent),
        task_type: taskType,
        previous_delays: parseInt(previousDelays)
      })
    });

    if (!response.ok) {
      const err = await response.text();
      throw new Error(`Prediction failed: ${err}`);
    }

    const data = await response.json();
    document.getElementById("predictionResult").innerText = `Prediction: ${data.prediction}`;
  } catch (err) {
    console.error(err);
    document.getElementById("predictionResult").innerText = "Error predicting progress";
  }
}


async function deleteEmployee(employeeId) {
    if (!confirm("Are you sure you want to delete this employee?")) return;

    try {
        const response = await fetch(`/api/employees/${employeeId}`, {
            method: "DELETE",
            credentials: "include"
        });

        if (!response.ok) throw new Error("Failed to delete employee");

        await fetchEmployees();  // refresh list after deletion
        await fetchStats();      // refresh stats
        alert("Employee deleted successfully!");
    } catch (err) {
        console.error("Error deleting employee:", err);
        alert("Error deleting employee");
    }
}

        // View employee details
        async function viewEmployeeDetails(employeeId) {
            try {
                const response = await fetch(`/api/employees/${employeeId}`,{
                method: "GET",
                credentials: "include"    
                });
                if (!response.ok) throw new Error('Failed to fetch employee details');
                
                const employee = await response.json();
                const progress = employee.progress;
                
                const formsProgress = Math.round((progress.forms_completed / progress.total_forms) * 100);
                const videosProgress = Math.round((progress.videos_completed / progress.total_videos) * 100);
                const docsProgress = Math.round((progress.documents_uploaded / progress.total_documents) * 100);
                
                document.getElementById('employeeDetailContent').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                        <div class="employee-avatar" style="width: 60px; height: 60px; font-size: 20px;">
                            ${employee.firstName.charAt(0)}${employee.lastName.charAt(0)}
                        </div>
                        <div>
                            <h3 style="margin: 0;">${employee.firstName} ${employee.lastName}</h3>
                            <p style="margin: 5px 0; color: #6c757d;">${employee.position} • ${employee.department}</p>
                            <p style="margin: 0; font-size: 14px;">Employee ID: ${employee.emp_id}</p>
                        </div>
                    </div>
                    
                    <div class="employee-detail">
                        <div class="progress-section">
                            <h4>Onboarding Progress</h4>
                            <div class="progress-item">
                                <div class="progress-title">
                                    <span>Forms Submission</span>
                                    <span class="progress-value">${progress.forms_completed}/${progress.total_forms}</span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${formsProgress}%"></div>
                                </div>
                            </div>
                            
                            <div class="progress-item">
                                <div class="progress-title">
                                    <span>Training Videos</span>
                                    <span class="progress-value">${progress.videos_completed}/${progress.total_videos}</span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${videosProgress}%"></div>
                                </div>
                            </div>
                            
                            <div class="progress-item">
                                <div class="progress-title">
                                    <span>Documents Uploaded</span>
                                    <span class="progress-value">${progress.documents_uploaded}/${progress.total_documents}</span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar" style="width: ${docsProgress}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                empDetailModal.style.display = 'flex';
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading employee details');
            }
        }

        // Tasks table update function
        function updateTasksTable(tasks) {
            tasksTableBody.innerHTML = '';
            
            tasks.forEach((task,index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.emp_id}</td>
                    <td>${task.emp_name}</td>
                    <td>${task.task_name}</td>
                    <td>${task.category}</td>
                    <td>${task.assigned_by}</td>
                    <td>${new Date(task.due_date).toLocaleDateString()}</td>
                   <td>
                        <select class="status-dropdown" onchange="updateTaskStatus(${task.id}, this.value)">
                            <option value="Not Started" ${task.status === 'Not Started' ? 'selected' : ''}>Not Started</option>
                            <option value="In Progress" ${task.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </td>

                    <td>
                        <button class="action-btn" onclick="editTask(${task.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn" onclick="deleteTask(${task.id})" style="color: var(--danger);">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tasksTableBody.appendChild(row);
            });
        }

        // Training videos table update function
      function updateVideosTable(videos) {
    videosTableBody.innerHTML = '';
    
    videos.forEach(video => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${video.title}</td>
            <td>${video.duration}</td>
            <td>${video.category}</td>
            <td>${new Date(video.upload_date).toLocaleDateString()}</td>
            <td>
                <button class="action-btn" onclick="viewVideo('${video.url}', '${video.title}')">
                    <i class="fas fa-play"></i> View
                </button>
            </td>

        `;
        videosTableBody.appendChild(row);
    });
}

async function fetchTrainingVideos() {
    try {
        const response = await fetch('/api/training-videos', { credentials: 'include' });
        const videos = await response.json();
        updateVideosTable(videos);
    } catch (err) {
        console.error('Error fetching videos:', err);
        alert('Failed to load training videos');
    }
}

// Call this when the Training section is selected
document.getElementById('training-section-btn').addEventListener('click', () => {
    fetchTrainingVideos();  // load videos when Training tab is clicked
});


        // Update stats cards
        function updateStats(stats) {
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Active Onboarding</h3>
                    <p class="stat-value">${stats.activeEmployees}</p>
                    <div class="stat-change ${stats.activeChange >= 0 ? 'up' : 'down'}">
                        <i class="fas fa-arrow-${stats.activeChange >= 0 ? 'up' : 'down'}"></i> 
                        ${Math.abs(stats.activeChange)} this week
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>Completed This Month</h3>
                    <p class="stat-value">${stats.completedThisMonth}</p>
                    <div class="stat-change ${stats.completionRate >= 0 ? 'up' : 'down'}">
                        <i class="fas fa-arrow-${stats.completionRate >= 0 ? 'up' : 'down'}"></i> 
                        ${Math.abs(stats.completionRate)}% from last month
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>Pending Tasks</h3>
                    <p class="stat-value">${stats.pendingTasks}</p>
                    <div class="stat-change ${stats.overdueTasks > 0 ? 'down' : 'up'}">
                        <i class="fas fa-arrow-${stats.overdueTasks > 0 ? 'down' : 'up'}"></i> 
                        ${stats.overdueTasks} overdue
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>Avg. Completion Time</h3>
                    <p class="stat-value">${stats.avgCompletionTime}</p>
                    <p style="font-size: 14px; margin-top: 5px;">days</p>
                </div>
            `;
        }

        // Fetch employees from API
        // Fetch employees from API and update table
async function fetchEmployees() {
    try {
        const response = await fetch("/api/employees", {
            method: "GET",
            credentials: "include"   // ✅ include session cookies
        });

        if (!response.ok) throw new Error("Failed to fetch employees");

        const employees = await response.json();

        // Add a progress object for each employee if not already present
        const employeesWithProgress = employees.map(emp => ({
            ...emp,
            progress: {
                forms_completed: emp.forms_completed || 0,
                total_forms: emp.total_forms || 1,
                videos_completed: emp.videos_completed || 0,
                total_videos: emp.total_videos || 1,
                documents_uploaded: emp.documents_uploaded || 0,
                total_documents: emp.total_documents || 1
            },
            // Optional: normalize field names to match table rendering
            firstName: emp.first_name,
            lastName: emp.last_name,
            startDate: emp.start_date
        }));

        // Update the employees table
        updateEmployeeTable(employeesWithProgress);
        populateTaskEmployeeDropdown(employeesWithProgress); // ✅ update dropdown
    } catch (err) {
        console.error("Error fetching employees:", err);
        alert("Error loading employee data");
    }
}


        // Fetch tasks from API
        async function fetchTasks() {
            try {
                const response = await fetch(`/api/tasks`,{
                    method:"GET",
                    credentials:"include"
                });
                if (!response.ok) throw new Error('Failed to fetch tasks');
                
                const tasks = await response.json();
                updateTasksTable(tasks);
            } catch (error) {
                console.error('Error fetching tasks:', error);
                alert('Error loading task data');
            }
        }

        // Fetch training videos from API
            async function fetchTrainingVideos() {
        try {
            const response = await fetch(`/api/training-videos`, {
                method: "GET",
                credentials: "include"   // ✅ keep session cookies
            });
            if (!response.ok) throw new Error("Failed to fetch training videos");
            const videos = await response.json();
            updateVideosTable(videos);
        } catch (error) {
            console.error("Error fetching training videos:", error);
            alert("Error loading training videos");
        }
    }


        // Fetch stats from API
        async function fetchStats() {
            try {
                const response = await fetch(`/api/stats`,{
                     method:"GET",
                    credentials:"include"
                });
                if (!response.ok) throw new Error('Failed to fetch stats');
                
                const stats = await response.json();
                updateStats(stats);
            } catch (error) {
                console.error('Error fetching stats:', error);
                // Fallback to default stats
                updateStats({
                    activeEmployees: 0,
                    activeChange: 0,
                    completedThisMonth: 0,
                    completionRate: 0,
                    pendingTasks: 0,
                    overdueTasks: 0,
                    avgCompletionTime: 0
                });
            }
        }

        // Delete task
         async function deleteTask(taskId) {
        if (!confirm('Are you sure you want to delete this task?')) return;

        try {
            const response = await fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE',
                credentials: "include"   // ✅ keep session cookies
            });

            if (response.ok) {
                await fetchTasks();
                alert('Task deleted successfully!');
            } else {
                throw new Error('Failed to delete task');
            }
        } catch (error) {
            console.error("Error deleting task:", error);
            alert("Error deleting task");
        }
    }

        // Edit task (placeholder)
        let editingTaskId = null; // global flag

// Open task form for editing
async function editTask(taskId) {
    try {
        // fetch existing task details
        const response = await fetch(`/api/tasks`, {
            method: "GET",
            credentials: "include"
        });
        const tasks = await response.json();
        const task = tasks.find(t => t.id === taskId);
        if (!task) return alert("Task not found!");

        // pre-fill form
        document.getElementById("taskEmpId").value = task.emp_id;
        document.getElementById("taskEmpName").value = task.emp_name;
        document.getElementById("taskName").value = task.task_name;
        document.getElementById("taskCategory").value = task.category;
        document.getElementById("taskAssignedBy").value = task.assigned_by;
        document.getElementById("taskDueDate").value = task.due_date.split("T")[0]; // format YYYY-MM-DD
        //document.getElementById("taskStatus").value = task.status || "Not Started";

        editingTaskId = taskId; // mark we’re editing

        alert(`Now editing Task ${taskId}. After changes, click "Assign Task" to save.`);
    } catch (err) {
        console.error("Error loading task:", err);
        alert("Error loading task for editing");
    }
}

// Modify existing taskForm submission
taskForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const taskData = {
    emp_id: document.getElementById("taskEmpId").value,
    emp_name: document.getElementById("taskEmpName").value,
    task_name: document.getElementById("taskName").value,
    category: document.getElementById("taskCategory").value,
    assigned_by: document.getElementById("taskAssignedBy").value,
    due_date: document.getElementById("taskDueDate").value,
    status:"Not Started"
  };

  let url = "/api/tasks";
  let method = "POST";

  if (editingTaskId) {
    url = `/api/tasks/${editingTaskId}`;
    method = "PUT";
  }

  try {
    const response = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(taskData)
    });

    if (!response.ok) throw new Error("Error while saving task");

    const msg = editingTaskId ? "Task updated successfully!" : "Task assigned successfully!";
    alert(msg);
    await fetchTasks();
    taskForm.reset();
    editingTaskId = null;
  } catch (err) {
    console.error("Error saving task:", err);
    alert("Error while saving task");
  }
});


        // Logout function
        function logout() {
            window.location.href = '/logout';
        }

        // Initialize the application
       document.addEventListener("DOMContentLoaded", async () => {
        await fetchEmployees();
        await fetchStats();
    });

async function fetchTasks() {
    try {
        const response = await fetch("/api/tasks", {
            method: "GET",
            credentials: "include"   // ✅ include session cookies
        });
        if (!response.ok) throw new Error("Failed to fetch tasks");
        const tasks = await response.json();
        updateTasksTable(tasks);
        
        //console.log("Tasks:", tasks);
        // render tasks to table...
    } catch (error) {
        console.error("Error fetching tasks:", error);
        alert("Error loading task data");
    }
}

async function fetchStats() {
    try {
        const response = await fetch(`/api/stats`, {
            method: "GET",
            credentials: "include"   // ✅ include session cookies
        });
        if (!response.ok) throw new Error("Failed to fetch stats");
        const stats = await response.json();
        console.log("Stats:", stats);
        // update dashboard UI...
        updateStats(stats);
    } catch (err) {
        console.error("Error fetching stats:", err);
    }
}

// Example for adding employee
async function addEmployee(employeeData) {
    try {
        const response = await fetch("/api/employees", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",   // ✅ include session cookies
            body: JSON.stringify(employeeData)
        });
        if (!response.ok) throw new Error("Failed to add employee");
        const result = await response.json();
        console.log("Employee added:", result);
        fetchEmployees(); // reload employees
    } catch (err) {
        console.error("Error adding employee:", err);
    }
}

function populateTaskEmployeeDropdown(employees) {
    const taskEmpSelect = document.getElementById('taskEmpId');
    taskEmpSelect.innerHTML = ''; // clear previous options

    employees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.emp_id;
        option.textContent = `${emp.firstName} ${emp.lastName}`;
        taskEmpSelect.appendChild(option);
    });
}

async function saveEmployeeProgress(empId) {
    const forms = document.getElementById(`forms_${empId}`).checked ? 1 : 0;
    const videos = document.getElementById(`videos_${empId}`).checked ? 1 : 0;
    const docs = document.getElementById(`docs_${empId}`).checked ? 1 : 0;

    const payload = {
        forms_completed: forms,
        videos_completed: videos,
        documents_uploaded: docs
    };

    try {
        const response = await fetch(`/api/employees/${empId}/progress`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error("Failed to update progress");

        await fetchEmployees(); // refresh table
       document.getElementById("empDetailModal").style.display = "none";
        alert("Employee progress updated successfully!");
    } catch (err) {
        console.error("Error saving progress:", err);
        alert("Error saving progress");
    }
}
function updateEmployeeProgress(empId, progress) {
  fetch(`/api/employees/${empId}/progress`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(progress)
  })
  .then(res => res.json())
  .then(data => {
    console.log("✅ Progress updated:", data);
    // You can refresh the progress bar here if needed
  })
  .catch(err => console.error("❌ Update failed:", err));
}
async function updateTaskStatus(taskId, newStatus) {
    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) throw new Error("Failed to update status");

        alert(`Task status updated to "${newStatus}"`);
        await fetchTasks(); // refresh table
    } catch (err) {
        console.error("Error updating status:", err);
        alert("Error updating task status");
    }
}

const addVideoBtn = document.getElementById('addVideoBtn');
const addVideoModal = document.getElementById('addVideoModal');
const videoForm = document.getElementById('videoForm');

addVideoBtn.addEventListener('click', () => {
    addVideoModal.style.display = 'flex';
});

function closeVideoModal() {
    addVideoModal.style.display = 'none';
    videoForm.reset();
}

// Close modal if clicking outside
window.addEventListener('click', (e) => {
    if (e.target === addVideoModal) closeAddVideoModal();
});

// Submit video form
videoForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const videoData = {
        title: document.getElementById('videoTitle').value,
        duration: document.getElementById('videoDuration').value,
        category: document.getElementById('videoCategory').value,
        url: document.getElementById('videoURL').value,
        upload_date: new Date().toISOString()
    };

    try {
        const response = await fetch('/api/training-videos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(videoData)
        });

        if (!response.ok) throw new Error('Failed to add video');

        alert('Video added successfully!');
        closeVideoModal();
        await fetchTrainingVideos(); // refresh video table
    } catch (err) {
        console.error(err);
        alert('Error adding video');
    }
});
function viewVideo(url) {
    if (!url) {
        alert("Video URL not found!");
        return;
    }
    // Open YouTube or valid URL in a new tab
    window.open(url, '_blank');
}
const generateReportBtn = document.getElementById('generateReportBtn');
const reportContainer = document.getElementById('report-container');

generateReportBtn.addEventListener('click', async () => {
    try {
        const response = await fetch('/api/report', { credentials: 'include' });
        if (!response.ok) throw new Error("Failed to fetch report data");
        const data = await response.json();
        renderReport(data);
    } catch (err) {
        console.error(err);
        alert("Error generating report");
    }
});

function renderReport(data) {
    const reportDiv = document.getElementById("report-container");
    reportDiv.innerHTML = "";

    data.forEach(emp => {
        const empHeader = document.createElement("h3");
        empHeader.textContent = `Employee: ${emp.employee_name}`;
        reportDiv.appendChild(empHeader);

        const table = document.createElement("table");
        table.className = "report-table";

        const headerRow = document.createElement("tr");
        headerRow.innerHTML = `
            <th>Task Name</th>
            <th>Assigned Date</th>
            <th>Due Date</th>
            <th>Current Status</th>
            <th>Report Status</th>
        `;
        table.appendChild(headerRow);

        emp.tasks.forEach(task => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${task.task_name}</td>
                <td>${task.assigned_date}</td>
                <td>${task.due_date}</td>
                <td>${task.current_status}</td>
                <td>${task.report_status}</td>
            `;
            table.appendChild(row);
        });

        reportDiv.appendChild(table);
    });



    fetch('http://127.0.0.1:5000/api/report')
  .then(res => res.json())
  .then(data => {
    data.forEach(emp => {
      console.log(emp.employee_name);
      emp.tasks.forEach(task => {
        console.log(task.task_name, '-', task.report_status);
        if (task.report_status === 'At Risk' || task.report_status === 'Delayed') {
          console.log('✅ Mocked email sent!');
        }
      });
    });
  });

}


</script>

</body>
</html>